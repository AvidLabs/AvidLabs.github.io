<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Kubernetes on Rocky Linux with Containerd | AvidLabs</title>
<meta name="keywords" content="" />
<meta name="description" content="This guide shows steps to install Kubernetes on Rocky Linux using kubeadm. I chose to use Rocky Linux for it&rsquo;s stability and RedHat compatibility. For my lab, I am installing Kubernetes with 1 master and 2 worker nodes, but you can install as many master and worker nodes as you would like, including just 1 node.
I have chosen to use containerd over Docker and CRI-O due to it&rsquo;s simplicity and lightweight nature.">
<meta name="author" content="">
<link rel="canonical" href="https://avidlabs.github.io/posts/kubeadmonrocky/" />
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.c88963fe2d79462000fd0fb1b3737783c32855d340583e4523343f8735c787f0.css" integrity="sha256-yIlj/i15RiAA/Q&#43;xs3N3g8MoVdNAWD5FIzQ/hzXHh/A=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.4dcb3c4f38462f66c6b6137227726f5543cb934cca9788f041c087e374491df2.js" integrity="sha256-Tcs8TzhGL2bGthNyJ3JvVUPLk0zKl4jwQcCH43RJHfI="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://avidlabs.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://avidlabs.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://avidlabs.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://avidlabs.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://avidlabs.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="Kubernetes on Rocky Linux with Containerd" />
<meta property="og:description" content="This guide shows steps to install Kubernetes on Rocky Linux using kubeadm. I chose to use Rocky Linux for it&rsquo;s stability and RedHat compatibility. For my lab, I am installing Kubernetes with 1 master and 2 worker nodes, but you can install as many master and worker nodes as you would like, including just 1 node.
I have chosen to use containerd over Docker and CRI-O due to it&rsquo;s simplicity and lightweight nature." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://avidlabs.github.io/posts/kubeadmonrocky/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-02-28T17:44:22-07:00" />
<meta property="article:modified_time" content="2022-02-28T17:44:22-07:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Kubernetes on Rocky Linux with Containerd"/>
<meta name="twitter:description" content="This guide shows steps to install Kubernetes on Rocky Linux using kubeadm. I chose to use Rocky Linux for it&rsquo;s stability and RedHat compatibility. For my lab, I am installing Kubernetes with 1 master and 2 worker nodes, but you can install as many master and worker nodes as you would like, including just 1 node.
I have chosen to use containerd over Docker and CRI-O due to it&rsquo;s simplicity and lightweight nature."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://avidlabs.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Kubernetes on Rocky Linux with Containerd",
      "item": "https://avidlabs.github.io/posts/kubeadmonrocky/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Kubernetes on Rocky Linux with Containerd",
  "name": "Kubernetes on Rocky Linux with Containerd",
  "description": "This guide shows steps to install Kubernetes on Rocky Linux using kubeadm. I chose to use Rocky Linux for it\u0026rsquo;s stability and RedHat compatibility. For my lab, I am installing Kubernetes with 1 master and 2 worker nodes, but you can install as many master and worker nodes as you would like, including just 1 node.\nI have chosen to use containerd over Docker and CRI-O due to it\u0026rsquo;s simplicity and lightweight nature.",
  "keywords": [
    
  ],
  "articleBody": "This guide shows steps to install Kubernetes on Rocky Linux using kubeadm. I chose to use Rocky Linux for it’s stability and RedHat compatibility. For my lab, I am installing Kubernetes with 1 master and 2 worker nodes, but you can install as many master and worker nodes as you would like, including just 1 node.\nI have chosen to use containerd over Docker and CRI-O due to it’s simplicity and lightweight nature. I will not be needing to use any docker specific commands as all containers should be running in the Kubernetes system.\nTable of Contents  System Requirements Rocky Linux Preparation  Installing Rocky Linux   Install Prerequisites  SSH Installing Container Runtime Installing Kubernetes Prerequisites   Install Kubernetes  Installing Kubernetes Master Node Installing Kubernetes Worker Nodes   Install Additional Kubernetes Tools  Install k9s, a cli based kubernetes dashboard Install kubectl-aliases, a programmatically generated list of kubectl aliases    System Requirements  At least 2 cores per node 4GB of RAM per master node 2GB of RAM per worker node 50GB of storage per node  These are not hard system requirements, so feel free to try running this with lower system specifications. These are the lowest requirements I feel comfortable running.\nRocky Linux Preparation Installing Rocky Linux Rocky Linux can be downloaded from the official Rocky Linux Site: https://rockylinux.org/\nFor this guide, I am using Rocky Linux 8.5 with the Minimal ISO.\n Boot to the Rocky Linux installer  I am using a mixture of Unraid and ESXi as a KVM hosts. In this case, I create a new VM, and mount the ISO file as a virtual disk.   For Installation Destination, select Custom, then Done I changed the partitioning scheme to Standard Partition over LVM, as I am more familiar with expanding these type of volumes if need be later on. Select ‘Click Here to create them automatically.’ Delete the swap partition and home partition, and set the desired capacity of / to the largest available size.  I kept the File System as xfs, but you can switch to ext4 here as well. Removing the swap partition is required for kubernetes Removing the home partition allows everything to be under the root directory, making storage management easier.   For Software Selection, I chose ‘Minimal Install’ as this used the least amount of resources.  We will be installing all required packages manually later on   For Network \u0026 Host Name, set a host name (unique for each node), and turn on the Ethernet adapter.  I chose kubemaster1, kubenode1, and kubenode2 I also set my router’s DHCP server to always assign the same IP address to each node.   Create a root user password, and standard user. Select install, and wait until Rocky Linux is fully installed. Select Reboot. Repeat this installation for each node.  Install Prerequisites SSH I find it easier to work with the VM over SSH instead of a virtual monitor. Rocky Linux minimal install comes with OpenSSH enabled by default, so you can SSH into the VM.\nInstalling Container Runtime Update system, patch firewall, and set SELinux to permissive sudo dnf update -y  sudo firewall-cmd --permanent --add-port=6443/tcp sudo firewall-cmd --permanent --add-port=2379-2380/tcp sudo firewall-cmd --permanent --add-port=10250/tcp sudo firewall-cmd --permanent --add-port=10251/tcp sudo firewall-cmd --permanent --add-port=10252/tcp sudo firewall-cmd --permanent --add-port=10255/tcp sudo firewall-cmd --reload  sudo setenforce 0 sudo sed -i 's/^SELINUX=.*/SELINUX=permissive/g' /etc/selinux/config Enable overlay and netfilter (required for Kubernetes and containerd networking), and configure sysctl sudo modprobe overlay sudo modprobe br_netfilter  sudo tee /etc/sysctl.d/kubernetes.confnet.bridge.bridge-nf-call-ip6tables = 1 net.bridge.bridge-nf-call-iptables = 1 net.ipv4.ip_forward = 1 EOF  cat br_netfilter EOF  sudo tee /etc/modules-load.d/containerd.conf overlay br_netfilter EOF  sudo sysctl --system Add official docker repository, and install containerd (We aren’t installing docker here, but the containerd package is located in the docker repository)\nsudo yum install -y yum-utils iproute-tc sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo sudo yum install -y containerd.io Set up containerd configuration sudo mkdir -p /etc/containerd sudo containerd config default  config.toml sudo mv config.toml /etc/containerd/config.toml Restart containerd and verify it is running sudo systemctl restart containerd sudo systemctl enable containerd sudo systemctl status containerd Check to make sure that the containerd service is active\nInstalling Kubernetes Prerequisites https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/\nNow that we have containerd, our container backend installed and working, let’s install kubernetes tools\nAdd kubernetes repository, install kubelet, kubeadm, kubectl, and enable kubelet Make sure to accept any keys on the update step\ncat [kubernetes] name=Kubernetes baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-\\$basearch enabled=1 gpgcheck=1 repo_gpgcheck=1 gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg exclude=kubelet kubeadm kubectl EOF  sudo yum update sudo yum install -y kubelet kubeadm kubectl --disableexcludes=kubernetes  sudo systemctl enable --now kubelet Here is a good time to reboot, and run the same steps on each worker node.\nsudo reboot Install Kubernetes Installing Kubernetes Master Node https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/\nRun these steps only on the master node\nBootstrap the kubernetes master using kubeadm sudo kubeadm init --pod-network-cidr=10.244.0.0/16 We are using this pod network cidr in particular for installing flannel, our kubernetes networking CNI\nThis step may take a while, once it finishes, you should see this message:\n Your Kubernetes control-plane has initialized successfully!  If this command fails, do not run kubeadm init again. Instead, you must first reset kubeadm by running this command, then fix any errors and try again sudo kubeadm reset Take note of your kubeadm join command. If you lose it, you can also regenerate this command by using sudo kubeadm token create --print-join-command Move kubectl config to the .kube directory mkdir -p $HOME/.kube sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config sudo chown $(id -u):$(id -g) $HOME/.kube/config Installing Kubernetes Worker Nodes On all nodes, run the kubeadm join command from the end of the master node setup sudo kubeadm join 111.111.111.111:6443 --token my.token --discovery-token-ca-cert-hash sha256:mycerthash On the master node, run this command and verify all nodes show up Note that the nodes will show as ‘NotReady’ until the CNI has been installed\nkubectl get nodes Install networking CNI (Flannel) https://github.com/flannel-io/flannel\nOn the master node (or anywhere you have kubectl installed, and the config file placed in ~/.kube/config), run the following commands kubectl apply -f https://raw.githubusercontent.com/flannel-io/flannel/master/Documentation/kube-flannel.yml  kubectl get pods --all-namespaces Wait until the coredns pod is running and ready\nOnce the codedns pod is running, verify that all nodes status is ‘Ready’ kubectl get nodes Remove Master Taint (if only using 1 node) Removing the master node taint allows us to run pods on the master node. If you only have 1 node, you will want to run everything on it, so the taint must be removed.\nRun this command on the master (or anywhere kubectl is configured to connect to the cluster) kubectl taint nodes --all node-role.kubernetes.io/master- Note that the command ends with master- with the - meaning remove\nThat means, you can re-taint the node by running:\nkubectl taint node nodename node-role.kubernetes.io/master=true:NoSchedule From here, your kubernetes cluster should be fully functioning.\nInstall Additional Kubernetes Tools Install k9s, a cli based kubernetes dashboard https://github.com/derailed/k9s\nwget https://github.com/derailed/k9s/releases/download/v0.25.18/k9s_Linux_x86_64.tar.gz tar -xzf k9s_Linux_x86_64.tar.gz chmod +x k9s 4sudo mv k9s /usr/local/bin/k9s Install kubectl-aliases, a programmatically generated list of kubectl aliases https://github.com/ahmetb/kubectl-aliases\nwget https://raw.githubusercontent.com/ahmetb/kubectl-aliases/master/.kubectl_aliases vim ~/.bashrc Add the following to the end of the file: [ -f ~/.kubectl_aliases ] \u0026\u0026 source ~/.kubectl_aliases function kubectl() { echo \"+ kubectl $@\"\u00262; command kubectl $@; } If you use zsh instead of bash, edit ~/.zshrc instead of ~/.bashrc\nReboot sudo reboot ",
  "wordCount" : "1197",
  "inLanguage": "en",
  "datePublished": "2022-02-28T17:44:22-07:00",
  "dateModified": "2022-02-28T17:44:22-07:00",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://avidlabs.github.io/posts/kubeadmonrocky/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "AvidLabs",
    "logo": {
      "@type": "ImageObject",
      "url": "https://avidlabs.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://avidlabs.github.io/" accesskey="h" title="AvidLabs (Alt + H)">AvidLabs</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
        <ul id="menu">
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title">
      Kubernetes on Rocky Linux with Containerd
    </h1>
    <div class="post-meta"><span title='2022-02-28 17:44:22 -0700 MST'>February 28, 2022</span>

</div>
  </header> 
  <div class="post-content"><p>This guide shows steps to install Kubernetes on Rocky Linux using kubeadm. I chose to use Rocky Linux for it&rsquo;s stability and RedHat compatibility. For my lab, I am installing Kubernetes with 1 master and 2 worker nodes, but you can install as many master and worker nodes as you would like, including just 1 node.</p>
<p>I have chosen to use containerd over Docker and CRI-O due to it&rsquo;s simplicity and lightweight nature. I will not be needing to use any docker specific commands as all containers should be running in the Kubernetes system.</p>
<h2 id="table-of-contents">Table of Contents<a hidden class="anchor" aria-hidden="true" href="#table-of-contents">#</a></h2>
<ul>
<li><a href="#system-requirements">System Requirements</a></li>
<li><a href="#rocky-linux-preparation">Rocky Linux Preparation</a>
<ul>
<li><a href="#installing-rocky-linux">Installing Rocky Linux</a></li>
</ul>
</li>
<li><a href="#install-prerequisites">Install Prerequisites</a>
<ul>
<li><a href="#ssh">SSH</a></li>
<li><a href="#installing-container-runtime">Installing Container Runtime</a></li>
<li><a href="#installing-kubernetes-prerequisites">Installing Kubernetes Prerequisites</a></li>
</ul>
</li>
<li><a href="#install-kubernetes">Install Kubernetes</a>
<ul>
<li><a href="#installing-kubernetes-master-node">Installing Kubernetes Master Node</a></li>
<li><a href="#installing-kubernetes-worker-nodes">Installing Kubernetes Worker Nodes</a></li>
</ul>
</li>
<li><a href="#install-additional-kubernetes-tools">Install Additional Kubernetes Tools</a>
<ul>
<li><a href="#install-k9s-a-cli-based-kubernetes-dashboard">Install k9s, a cli based kubernetes dashboard</a></li>
<li><a href="#install-kubectl-aliases-a-programmatically-generated-list-of-kubectl-aliases">Install kubectl-aliases, a programmatically generated list of kubectl aliases</a></li>
</ul>
</li>
</ul>
<h2 id="system-requirements">System Requirements<a hidden class="anchor" aria-hidden="true" href="#system-requirements">#</a></h2>
<ul>
<li>At least 2 cores per node</li>
<li>4GB of RAM per master node</li>
<li>2GB of RAM per worker node</li>
<li>50GB of storage per node</li>
</ul>
<p>These are not hard system requirements, so feel free to try running this with lower system specifications. These are the lowest requirements I feel comfortable running.</p>
<h2 id="rocky-linux-preparation">Rocky Linux Preparation<a hidden class="anchor" aria-hidden="true" href="#rocky-linux-preparation">#</a></h2>
<h4 id="installing-rocky-linux">Installing Rocky Linux<a hidden class="anchor" aria-hidden="true" href="#installing-rocky-linux">#</a></h4>
<p>Rocky Linux can be downloaded from the official Rocky Linux Site: <a href="https://rockylinux.org/">https://rockylinux.org/</a></p>
<p>For this guide, I am using Rocky Linux 8.5 with the Minimal ISO.</p>
<ol>
<li>Boot to the Rocky Linux installer
<ul>
<li>I am using a mixture of Unraid and ESXi as a KVM hosts. In this case, I create a new VM, and mount the ISO file as a virtual disk.</li>
</ul>
</li>
<li>For Installation Destination, select Custom, then Done</li>
<li>I changed the partitioning scheme to Standard Partition over LVM, as I am more familiar with expanding these type of volumes if need be later on.</li>
<li>Select &lsquo;Click Here to create them automatically.&rsquo;</li>
<li>Delete the swap partition and home partition, and set the desired capacity of / to the largest available size.
<ul>
<li>I kept the File System as xfs, but you can switch to ext4 here as well.</li>
<li>Removing the swap partition is required for kubernetes</li>
<li>Removing the home partition allows everything to be under the root directory, making storage management easier.</li>
</ul>
</li>
<li>For Software Selection, I chose &lsquo;Minimal Install&rsquo; as this used the least amount of resources.
<ul>
<li>We will be installing all required packages manually later on</li>
</ul>
</li>
<li>For Network &amp; Host Name, set a host name (unique for each node), and turn on the Ethernet adapter.
<ul>
<li>I chose kubemaster1, kubenode1, and kubenode2</li>
<li>I also set my router&rsquo;s DHCP server to always assign the same IP address to each node.</li>
</ul>
</li>
<li>Create a root user password, and standard user. Select install, and wait until Rocky Linux is fully installed. Select Reboot. Repeat this installation for each node.</li>
</ol>
<h2 id="install-prerequisites">Install Prerequisites<a hidden class="anchor" aria-hidden="true" href="#install-prerequisites">#</a></h2>
<h4 id="ssh">SSH<a hidden class="anchor" aria-hidden="true" href="#ssh">#</a></h4>
<p>I find it easier to work with the VM over SSH instead of a virtual monitor. Rocky Linux minimal install comes with OpenSSH enabled by default, so you can SSH into the VM.</p>
<h4 id="installing-container-runtime">Installing Container Runtime<a hidden class="anchor" aria-hidden="true" href="#installing-container-runtime">#</a></h4>
<h5 id="update-system-patch-firewall-and-set-selinux-to-permissive">Update system, patch firewall, and set SELinux to permissive<a hidden class="anchor" aria-hidden="true" href="#update-system-patch-firewall-and-set-selinux-to-permissive">#</a></h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo dnf update -y
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sudo firewall-cmd --permanent --add-port<span style="color:#f92672">=</span>6443/tcp
</span></span><span style="display:flex;"><span>sudo firewall-cmd --permanent --add-port<span style="color:#f92672">=</span>2379-2380/tcp
</span></span><span style="display:flex;"><span>sudo firewall-cmd --permanent --add-port<span style="color:#f92672">=</span>10250/tcp
</span></span><span style="display:flex;"><span>sudo firewall-cmd --permanent --add-port<span style="color:#f92672">=</span>10251/tcp
</span></span><span style="display:flex;"><span>sudo firewall-cmd --permanent --add-port<span style="color:#f92672">=</span>10252/tcp
</span></span><span style="display:flex;"><span>sudo firewall-cmd --permanent --add-port<span style="color:#f92672">=</span>10255/tcp
</span></span><span style="display:flex;"><span>sudo firewall-cmd --reload
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sudo setenforce <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>sudo sed -i <span style="color:#e6db74">&#39;s/^SELINUX=.*/SELINUX=permissive/g&#39;</span> /etc/selinux/config
</span></span></code></pre></div><h5 id="enable-overlay-and-netfilter-required-for-kubernetes-and-containerd-networking-and-configure-sysctl">Enable overlay and netfilter (required for Kubernetes and containerd networking), and configure sysctl<a hidden class="anchor" aria-hidden="true" href="#enable-overlay-and-netfilter-required-for-kubernetes-and-containerd-networking-and-configure-sysctl">#</a></h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo modprobe overlay
</span></span><span style="display:flex;"><span>sudo modprobe br_netfilter
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sudo tee /etc/sysctl.d/kubernetes.conf<span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.bridge.bridge-nf-call-ip6tables = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.bridge.bridge-nf-call-iptables = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.ipv4.ip_forward = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOF | sudo tee /etc/modules-load.d/k8s.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">br_netfilter
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sudo tee /etc/modules-load.d/containerd.conf <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">overlay
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">br_netfilter
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sudo sysctl --system
</span></span></code></pre></div><h5 id="add-official-docker-repository-and-install-containerd">Add official docker repository, and install containerd<a hidden class="anchor" aria-hidden="true" href="#add-official-docker-repository-and-install-containerd">#</a></h5>
<p>(We aren&rsquo;t installing docker here, but the containerd package is located in the docker repository)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo yum install -y yum-utils iproute-tc
</span></span><span style="display:flex;"><span>sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
</span></span><span style="display:flex;"><span>sudo yum install -y containerd.io
</span></span></code></pre></div><h5 id="set-up-containerd-configuration">Set up containerd configuration<a hidden class="anchor" aria-hidden="true" href="#set-up-containerd-configuration">#</a></h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo mkdir -p /etc/containerd 
</span></span><span style="display:flex;"><span>sudo containerd config default &gt; config.toml
</span></span><span style="display:flex;"><span>sudo mv config.toml /etc/containerd/config.toml
</span></span></code></pre></div><h5 id="restart-containerd-and-verify-it-is-running">Restart containerd and verify it is running<a hidden class="anchor" aria-hidden="true" href="#restart-containerd-and-verify-it-is-running">#</a></h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo systemctl restart containerd
</span></span><span style="display:flex;"><span>sudo systemctl enable containerd
</span></span><span style="display:flex;"><span>sudo systemctl status containerd
</span></span></code></pre></div><p>Check to make sure that the containerd service is active</p>
<h4 id="installing-kubernetes-prerequisites">Installing Kubernetes Prerequisites<a hidden class="anchor" aria-hidden="true" href="#installing-kubernetes-prerequisites">#</a></h4>
<p><a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/">https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/</a></p>
<p>Now that we have containerd, our container backend installed and working, let&rsquo;s install kubernetes tools</p>
<h5 id="add-kubernetes-repository-install-kubelet-kubeadm-kubectl-and-enable-kubelet">Add kubernetes repository, install kubelet, kubeadm, kubectl, and enable kubelet<a hidden class="anchor" aria-hidden="true" href="#add-kubernetes-repository-install-kubelet-kubeadm-kubectl-and-enable-kubelet">#</a></h5>
<p>Make sure to accept any keys on the update step</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOF | sudo tee /etc/yum.repos.d/kubernetes.repo
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[kubernetes]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">name=Kubernetes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-\$basearch
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">enabled=1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">gpgcheck=1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">repo_gpgcheck=1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">exclude=kubelet kubeadm kubectl
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sudo yum update
</span></span><span style="display:flex;"><span>sudo yum install -y kubelet kubeadm kubectl --disableexcludes<span style="color:#f92672">=</span>kubernetes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sudo systemctl enable --now kubelet
</span></span></code></pre></div><p>Here is a good time to reboot, and run the same steps on each worker node.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo reboot
</span></span></code></pre></div><h2 id="install-kubernetes">Install Kubernetes<a hidden class="anchor" aria-hidden="true" href="#install-kubernetes">#</a></h2>
<h4 id="installing-kubernetes-master-node">Installing Kubernetes Master Node<a hidden class="anchor" aria-hidden="true" href="#installing-kubernetes-master-node">#</a></h4>
<p><a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/">https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/</a></p>
<p>Run these steps only on the master node</p>
<h5 id="bootstrap-the-kubernetes-master-using-kubeadm">Bootstrap the kubernetes master using kubeadm<a hidden class="anchor" aria-hidden="true" href="#bootstrap-the-kubernetes-master-using-kubeadm">#</a></h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo kubeadm init --pod-network-cidr<span style="color:#f92672">=</span>10.244.0.0/16
</span></span></code></pre></div><p>We are using this pod network cidr in particular for installing flannel, our kubernetes networking CNI</p>
<p>This step may take a while, once it finishes, you should see this message:</p>
<ul>
<li>Your Kubernetes control-plane has initialized successfully!</li>
</ul>
<h5 id="if-this-command-fails-do-not-run-kubeadm-init-again-instead-you-must-first-reset-kubeadm-by-running-this-command-then-fix-any-errors-and-try-again">If this command fails, do not run kubeadm init again. Instead, you must first reset kubeadm by running this command, then fix any errors and try again<a hidden class="anchor" aria-hidden="true" href="#if-this-command-fails-do-not-run-kubeadm-init-again-instead-you-must-first-reset-kubeadm-by-running-this-command-then-fix-any-errors-and-try-again">#</a></h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo kubeadm reset
</span></span></code></pre></div><h5 id="take-note-of-your-kubeadm-join-command-if-you-lose-it-you-can-also-regenerate-this-command-by-using">Take note of your kubeadm join command. If you lose it, you can also regenerate this command by using<a hidden class="anchor" aria-hidden="true" href="#take-note-of-your-kubeadm-join-command-if-you-lose-it-you-can-also-regenerate-this-command-by-using">#</a></h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo kubeadm token create --print-join-command
</span></span></code></pre></div><h5 id="move-kubectl-config-to-the-kube-directory">Move kubectl config to the .kube directory<a hidden class="anchor" aria-hidden="true" href="#move-kubectl-config-to-the-kube-directory">#</a></h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mkdir -p $HOME/.kube
</span></span><span style="display:flex;"><span>sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
</span></span><span style="display:flex;"><span>sudo chown <span style="color:#66d9ef">$(</span>id -u<span style="color:#66d9ef">)</span>:<span style="color:#66d9ef">$(</span>id -g<span style="color:#66d9ef">)</span> $HOME/.kube/config
</span></span></code></pre></div><h4 id="installing-kubernetes-worker-nodes">Installing Kubernetes Worker Nodes<a hidden class="anchor" aria-hidden="true" href="#installing-kubernetes-worker-nodes">#</a></h4>
<h5 id="on-all-nodes-run-the-kubeadm-join-command-from-the-end-of-the-master-node-setup">On all nodes, run the kubeadm join command from the end of the master node setup<a hidden class="anchor" aria-hidden="true" href="#on-all-nodes-run-the-kubeadm-join-command-from-the-end-of-the-master-node-setup">#</a></h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo kubeadm join 111.111.111.111:6443 --token my.token --discovery-token-ca-cert-hash sha256:mycerthash
</span></span></code></pre></div><h5 id="on-the-master-node-run-this-command-and-verify-all-nodes-show-up">On the master node, run this command and verify all nodes show up<a hidden class="anchor" aria-hidden="true" href="#on-the-master-node-run-this-command-and-verify-all-nodes-show-up">#</a></h5>
<p>Note that the nodes will show as &lsquo;NotReady&rsquo; until the CNI has been installed</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl get nodes
</span></span></code></pre></div><h4 id="install-networking-cni-flannel">Install networking CNI (Flannel)<a hidden class="anchor" aria-hidden="true" href="#install-networking-cni-flannel">#</a></h4>
<p><a href="https://github.com/flannel-io/flannel">https://github.com/flannel-io/flannel</a></p>
<h5 id="on-the-master-node-or-anywhere-you-have-kubectl-installed-and-the-config-file-placed-in-kubeconfig-run-the-following-commands">On the master node (or anywhere you have kubectl installed, and the config file placed in ~/.kube/config), run the following commands<a hidden class="anchor" aria-hidden="true" href="#on-the-master-node-or-anywhere-you-have-kubectl-installed-and-the-config-file-placed-in-kubeconfig-run-the-following-commands">#</a></h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl apply -f https://raw.githubusercontent.com/flannel-io/flannel/master/Documentation/kube-flannel.yml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl get pods --all-namespaces
</span></span></code></pre></div><p>Wait until the coredns pod is running and ready</p>
<h5 id="once-the-codedns-pod-is-running-verify-that-all-nodes-status-is-ready">Once the codedns pod is running, verify that all nodes status is &lsquo;Ready&rsquo;<a hidden class="anchor" aria-hidden="true" href="#once-the-codedns-pod-is-running-verify-that-all-nodes-status-is-ready">#</a></h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl get nodes
</span></span></code></pre></div><h4 id="remove-master-taint-if-only-using-1-node">Remove Master Taint (if only using 1 node)<a hidden class="anchor" aria-hidden="true" href="#remove-master-taint-if-only-using-1-node">#</a></h4>
<p>Removing the master node taint allows us to run pods on the master node. If you only have 1 node, you will want to run everything on it, so the taint must be removed.</p>
<h5 id="run-this-command-on-the-master-or-anywhere-kubectl-is-configured-to-connect-to-the-cluster">Run this command on the master (or anywhere kubectl is configured to connect to the cluster)<a hidden class="anchor" aria-hidden="true" href="#run-this-command-on-the-master-or-anywhere-kubectl-is-configured-to-connect-to-the-cluster">#</a></h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl taint nodes --all node-role.kubernetes.io/master-
</span></span></code></pre></div><p>Note that the command ends with master- with the - meaning remove</p>
<p>That means, you can re-taint the node by running:</p>
<pre tabindex="0"><code>kubectl taint node nodename node-role.kubernetes.io/master=true:NoSchedule
</code></pre><p>From here, your kubernetes cluster should be fully functioning.</p>
<h2 id="install-additional-kubernetes-tools">Install Additional Kubernetes Tools<a hidden class="anchor" aria-hidden="true" href="#install-additional-kubernetes-tools">#</a></h2>
<h4 id="install-k9s-a-cli-based-kubernetes-dashboard">Install k9s, a cli based kubernetes dashboard<a hidden class="anchor" aria-hidden="true" href="#install-k9s-a-cli-based-kubernetes-dashboard">#</a></h4>
<p><a href="https://github.com/derailed/k9s">https://github.com/derailed/k9s</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://github.com/derailed/k9s/releases/download/v0.25.18/k9s_Linux_x86_64.tar.gz 
</span></span><span style="display:flex;"><span>tar -xzf k9s_Linux_x86_64.tar.gz 
</span></span><span style="display:flex;"><span>chmod +x k9s 4sudo mv k9s /usr/local/bin/k9s
</span></span></code></pre></div><h4 id="install-kubectl-aliases-a-programmatically-generated-list-of-kubectl-aliases">Install kubectl-aliases, a programmatically generated list of kubectl aliases<a hidden class="anchor" aria-hidden="true" href="#install-kubectl-aliases-a-programmatically-generated-list-of-kubectl-aliases">#</a></h4>
<p><a href="https://github.com/ahmetb/kubectl-aliases">https://github.com/ahmetb/kubectl-aliases</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://raw.githubusercontent.com/ahmetb/kubectl-aliases/master/.kubectl_aliases 
</span></span><span style="display:flex;"><span>vim ~/.bashrc
</span></span></code></pre></div><h5 id="add-the-following-to-the-end-of-the-file">Add the following to the end of the file:<a hidden class="anchor" aria-hidden="true" href="#add-the-following-to-the-end-of-the-file">#</a></h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span> -f ~/.kubectl_aliases <span style="color:#f92672">]</span> <span style="color:#f92672">&amp;&amp;</span> source ~/.kubectl_aliases 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> kubectl<span style="color:#f92672">()</span> <span style="color:#f92672">{</span> echo <span style="color:#e6db74">&#34;+ kubectl </span>$@<span style="color:#e6db74">&#34;</span>&gt;&amp;2; command kubectl $@; <span style="color:#f92672">}</span>
</span></span></code></pre></div><p>If you use zsh instead of bash, edit  ~/.zshrc instead of ~/.bashrc</p>
<h5 id="reboot">Reboot<a hidden class="anchor" aria-hidden="true" href="#reboot">#</a></h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo reboot
</span></span></code></pre></div>

  </div>

  <footer class="post-footer">
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2022 <a href="https://avidlabs.github.io/">AvidLabs</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
